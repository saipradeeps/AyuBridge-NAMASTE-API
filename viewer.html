<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayush Terminology Search (Viewer)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .suggestion-item:hover { background-color: #f3f4f6; } /* light gray */
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-700">Ayush Terminology Mapper (Viewer Mode)</h1>
            <p class="text-lg text-gray-600 mt-2">A prototype for integrating AYUSH terms with modern EHR standards.</p>
        </header>

        <main class="bg-white rounded-lg shadow-lg p-6 md:p-8">
            <div class="mb-6">
                <label for="diagnosis-search" class="block text-sm font-medium text-black-700 mb-2">1. Enter Diagnosis Term to View Mappings</label>
                <div class="relative">
                    <input type="text" id="diagnosis-search" class="w-full bg-white border border-gray-300 text-black-900 rounded-md p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., Amlapitta or Joint Pain...">
                    <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg hidden"></div>
                </div>
            </div>

            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">2. Selected Codes (Patient's Problem List)</h2>
                <div id="problem-list-container" class="bg-gray-50 rounded-md p-4 min-h-[80px] border border-gray-200">
                    <p class="text-gray-500 italic">Codes selected will appear here...</p>
                </div>
            </div>

            <div>
                <h2 class="text-lg font-semibold text-gray-700 mb-3">3. Generated FHIR ProblemList Resource</h2>
                <div class="bg-gray-800 rounded-md p-4 max-h-96 overflow-auto">
                    <pre><code id="fhir-output" class="text-sm text-green-300 whitespace-pre-wrap"></code></pre>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DOM ELEMENT REFERENCES ---
        const searchInput = document.getElementById('diagnosis-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const problemListContainer = document.getElementById('problem-list-container');
        const fhirOutput = document.getElementById('fhir-output');

        let selectedProblems = [];

        // --- FUNCTIONS ---

        /**
         * Renders the suggestions based on user input by calling the backend API.
         * @param {string} query The user's search term.
         */
        async function renderSuggestions(query) {
            suggestionsContainer.innerHTML = '';
            if (!query || query.trim().length === 0) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            
            // Construct the API URL to your live backend
            const apiUrl = `http://127.0.0.1:8000/search?query=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.error("API Error:", response.status, response.statusText);
                    suggestionsContainer.classList.add('hidden');
                    return;
                }

                const results = await response.json();

                if (results.length > 0) {
                    results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'p-3 cursor-pointer suggestion-item transition';
                        div.innerHTML = `
                            <p class="font-semibold text-black">${item.namaste_term}</p>
                            <p class="text-sm text-gray-400">Maps to ICD-11: ${item.icd11_term}</p>
                        `;
                        // Map the backend data structure to what the frontend functions expect
                        const formattedTerm = {
                            ayushTerm: item.namaste_term,
                            namasteCode: item.namaste_code,
                            icd11Code: item.icd11_code,
                            icd11Description: item.icd11_term
                        };
                        div.onclick = () => selectTerm(formattedTerm);
                        suggestionsContainer.appendChild(div);
                    });
                    suggestionsContainer.classList.remove('hidden');
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error("Failed to fetch from API:", error);
                suggestionsContainer.innerHTML = `<div class="p-3 text-red-400">Error: Could not connect to the API. Is the backend server running?</div>`;
                suggestionsContainer.classList.remove('hidden');
            }
        }

        /**
         * Handles the selection of a term from the suggestions.
         * @param {object} term The selected terminology object.
         */
        function selectTerm(term) {
            if (!selectedProblems.some(p => p.namasteCode === term.namasteCode)) {
                selectedProblems.push(term);
                renderProblemList();
                generateFhirResource();
            }
            searchInput.value = '';
            suggestionsContainer.classList.add('hidden');
        }

        /**
         * Renders the list of selected problems.
         */
        function renderProblemList() {
            if (selectedProblems.length === 0) {
                problemListContainer.innerHTML = `<p class="text-gray-500 italic">Codes selected will appear here...</p>`;
            } else {
                problemListContainer.innerHTML = selectedProblems.map((problem, index) => `
                    <div class="bg-blue-200 border border-blue-300 p-3 rounded-md mb-2 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-blue-900">${problem.ayushTerm}</p>
                            <p class="text-xs text-blue-800"><strong>NAMASTE:</strong> ${problem.namasteCode} | <strong>ICD-11:</strong> ${problem.icd11Code} (${problem.icd11Description})</p>
                        </div>
                        <button onclick="removeProblem(${index})" class="text-red-600 hover:text-red-500 font-bold text-xl">&times;</button>
                    </div>`).join('');
            }
        }
        
        function removeProblem(index) {
            selectedProblems.splice(index, 1);
            renderProblemList();
            generateFhirResource();
        }

        function generateFhirResource() {
            const fhirResource = {
                resourceType: "List", id: "problem-list-example", status: "current", mode: "snapshot",
                title: "Patient Problem List", subject: { reference: "Patient/example", display: "John Doe" },
                date: new Date().toISOString(),
                entry: selectedProblems.map(problem => ({
                    item: {
                        display: `Condition: ${problem.ayushTerm} / ${problem.icd11Description}`,
                        _extension_namaste: { system: "http://nphce.org.in/namaste", code: problem.namasteCode, display: problem.ayushTerm },
                        _extension_icd11: { system: "http://id.who.int/icd/release/11/mms", code: problem.icd11Code, display: problem.icd11Description }
                    }
                }))
            };
            fhirOutput.textContent = JSON.stringify(fhirResource, null, 2);
        }

        searchInput.addEventListener('input', () => renderSuggestions(searchInput.value));
        document.addEventListener('click', event => {
            if (!suggestionsContainer.contains(event.target) && event.target !== searchInput) {
                suggestionsContainer.classList.add('hidden');
            }
        });
        generateFhirResource();
    </script>
</body>
</html>

