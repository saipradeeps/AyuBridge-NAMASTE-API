<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayush Terminology Search Prototype (Live)</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A little custom style for a professional look */
        body {
            font-family: 'Inter', sans-serif;
        }
        .suggestion-item:hover {
            background-color: #374151; /* Darker gray on hover */
        }
    </style>
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-cyan-400">Ayush Terminology Mapper</h1>
            <p class="text-lg text-gray-400 mt-2">A prototype for integrating AYUSH terms with modern EHR standards.</p>
        </header>

        <main class="bg-gray-800 rounded-lg shadow-2xl p-6 md:p-8">
            <!-- Search Section -->
            <div class="mb-6">
                <label for="diagnosis-search" class="block text-sm font-medium text-gray-300 mb-2">1. Enter Diagnosis Term</label>
                <div class="relative">
                    <input type="text" id="diagnosis-search" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-3 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition" placeholder="e.g., Amlapitta or Joint Pain...">
                    <!-- Suggestions will be populated here -->
                    <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded-md shadow-lg hidden"></div>
                </div>
            </div>

            <!-- Problem List Section -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-300 mb-3">2. Selected Codes (Patient's Problem List)</h2>
                <div id="problem-list-container" class="bg-gray-900/50 rounded-md p-4 min-h-[80px] border border-gray-700">
                    <p class="text-gray-500 italic">Codes selected will appear here...</p>
                </div>
            </div>

            <!-- FHIR Resource Output Section -->
            <div>
                <h2 class="text-lg font-semibold text-gray-300 mb-3">3. Generated FHIR ProblemList Resource</h2>
                <div class="bg-black rounded-md p-4 max-h-96 overflow-auto">
                    <pre><code id="fhir-output" class="text-sm text-green-300 whitespace-pre-wrap"></code></pre>
                </div>
            </div>
        </main>

    </div>

    <script>
        // --- DOM ELEMENT REFERENCES ---
        const searchInput = document.getElementById('diagnosis-search');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const problemListContainer = document.getElementById('problem-list-container');
        const fhirOutput = document.getElementById('fhir-output');

        let selectedProblems = [];

        // --- FUNCTIONS ---

        /**
         * Renders the suggestions based on user input by calling the backend API.
         * @param {string} query The user's search term.
         */
        async function renderSuggestions(query) {
            suggestionsContainer.innerHTML = '';
            if (!query || query.trim().length === 0) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            
            // Construct the API URL to your live backend
            const apiUrl = `http://127.0.0.1:8000/search?query=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.error("API Error:", response.status, response.statusText);
                    suggestionsContainer.classList.add('hidden');
                    return;
                }

                const results = await response.json();

                if (results.length > 0) {
                    results.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'p-3 cursor-pointer suggestion-item transition';
                        div.innerHTML = `
                            <p class="font-semibold text-white">${item.namaste_term}</p>
                            <p class="text-sm text-gray-400">Maps to ICD-11: ${item.icd11_term}</p>
                        `;
                        // Map the backend data structure to what the frontend functions expect
                        const formattedTerm = {
                            ayushTerm: item.namaste_term,
                            namasteCode: item.namaste_code,
                            icd11Code: item.icd11_code,
                            icd11Description: item.icd11_term
                        };
                        div.onclick = () => selectTerm(formattedTerm);
                        suggestionsContainer.appendChild(div);
                    });
                    suggestionsContainer.classList.remove('hidden');
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error("Failed to fetch from API:", error);
                suggestionsContainer.innerHTML = `<div class="p-3 text-red-400">Error: Could not connect to the API. Is the backend server running?</div>`;
                suggestionsContainer.classList.remove('hidden');
            }
        }

        /**
         * Handles the selection of a term from the suggestions.
         * @param {object} term The selected terminology object.
         */
        function selectTerm(term) {
            if (!selectedProblems.some(p => p.namasteCode === term.namasteCode)) {
                selectedProblems.push(term);
                renderProblemList();
                generateFhirResource();
            }
            searchInput.value = '';
            suggestionsContainer.classList.add('hidden');
        }

        /**
         * Renders the list of selected problems.
         */
        function renderProblemList() {
            if (selectedProblems.length === 0) {
                problemListContainer.innerHTML = `<p class="text-gray-500 italic">Codes selected will appear here...</p>`;
            } else {
                problemListContainer.innerHTML = selectedProblems.map((problem, index) => `
                    <div class="bg-cyan-900/50 p-3 rounded-md mb-2 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-cyan-300">${problem.ayushTerm}</p>
                            <p class="text-xs text-gray-300">
                                <strong>NAMASTE:</strong> ${problem.namasteCode} | 
                                <strong>ICD-11:</strong> ${problem.icd11Code} (${problem.icd11Description})
                            </p>
                        </div>
                        <button onclick="removeProblem(${index})" class="text-red-400 hover:text-red-300 font-bold text-xl">&times;</button>
                    </div>
                `).join('');
            }
        }
        
        /**
         * Removes a problem from the selected list.
         * @param {number} index The index of the problem to remove.
         */
        function removeProblem(index) {
            selectedProblems.splice(index, 1);
            renderProblemList();
            generateFhirResource();
        }

        /**
         * Generates and displays the FHIR ProblemList resource JSON.
         */
        function generateFhirResource() {
            const fhirResource = {
                resourceType: "List",
                id: "problem-list-example",
                status: "current",
                mode: "snapshot",
                title: "Patient Problem List",
                subject: {
                    reference: "Patient/example",
                    display: "John Doe"
                },
                date: new Date().toISOString(),
                entry: selectedProblems.map((problem, index) => ({
                    item: { 
                        display: `Condition: ${problem.ayushTerm} / ${problem.icd11Description}`,
                        _extension_namaste: {
                            system: "http://nphce.org.in/namaste",
                            code: problem.namasteCode,
                            display: problem.ayushTerm
                        },
                         _extension_icd11: {
                            system: "http://id.who.int/icd/release/11/mms",
                            code: problem.icd11Code,
                            display: problem.icd11Description
                        }
                    }
                }))
            };

            fhirOutput.textContent = JSON.stringify(fhirResource, null, 2);
        }

        // --- EVENT LISTENERS ---
        searchInput.addEventListener('input', () => renderSuggestions(searchInput.value));

        document.addEventListener('click', (event) => {
            if (!suggestionsContainer.contains(event.target) && event.target !== searchInput) {
                suggestionsContainer.classList.add('hidden');
            }
        });

        // --- INITIALIZATION ---
        generateFhirResource();

    </script>
</body>
</html>

