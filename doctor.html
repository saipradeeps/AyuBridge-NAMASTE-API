<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AyuBridge - Doctor's Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .hero-background { background: linear-gradient(135deg, #1A3E39 0%, #0D2622 100%); }
        .suggestion-item:hover { background-color: #2d574e; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0D2622; }
        ::-webkit-scrollbar-thumb { background-color: #10B981; border-radius: 10px; border: 2px solid #0D2622; }
    </style>
</head>
<body class="hero-background text-gray-200 min-h-screen">

    <header class="bg-white bg-opacity-5 backdrop-blur-sm sticky top-0 z-10 p-4 shadow-lg">
        <nav class="container mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <svg class="w-8 h-8 text-white mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                <span class="text-white text-xl font-bold">AyuBridge</span>
            </div>
            <a href="./index.html" class="bg-[#10B981] text-white px-6 py-2 rounded-full font-semibold hover:bg-green-600 transition duration-300">Logout</a>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="w-full bg-white bg-opacity-10 rounded-2xl p-6 md:p-8 shadow-2xl backdrop-blur-sm mt-8">
            <h1 class="text-3xl font-bold text-white mb-6">Doctor's Dashboard</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Patient Management -->
                <div class="lg:col-span-1 space-y-6">
                    <div>
                        <label for="patient-select" class="block text-sm font-medium text-green-200 mb-2">Select Patient</label>
                        <select id="patient-select" class="w-full bg-white bg-opacity-20 border border-transparent text-white rounded-md p-3 focus:ring-2 focus:ring-green-300 transition">
                        </select>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold text-green-200 mb-3">Patient's Problem List</h2>
                        <div id="patient-problem-list" class="bg-black bg-opacity-20 rounded-md p-4 min-h-[200px] border border-gray-700 space-y-3">
                            <p class="text-gray-400 italic">Select a patient to view their record.</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Terminology Mapper -->
                <div class="lg:col-span-2 space-y-6">
                    <div>
                        <label for="diagnosis-search" class="block text-sm font-medium text-green-200 mb-2">1. Add New Diagnosis (Search Term)</label>
                        <div class="relative">
                            <input type="text" id="diagnosis-search" class="w-full bg-white bg-opacity-20 border border-transparent text-white rounded-md p-3 focus:ring-2 focus:ring-green-300 transition placeholder-gray-400" placeholder="e.g., Kasa or Cough...">
                            <div id="suggestions-container" class="absolute z-10 w-full mt-1 bg-[#0D2622] border border-gray-700 rounded-md shadow-lg hidden max-h-60 overflow-y-auto"></div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-green-200 mb-3">2. Staging Area (Codes to be added)</h2>
                        <div id="staging-area-container" class="bg-black bg-opacity-20 rounded-md p-4 min-h-[80px] border border-gray-700">
                             <p class="text-gray-400 italic">Codes selected from search will appear here...</p>
                        </div>
                        <button id="save-to-record-btn" class="mt-4 w-full bg-[#10B981] hover:bg-green-600 text-white font-bold py-3 px-4 rounded-full transition duration-300 text-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Save to Patient Record</button>
                    </div>
                    <!-- ADD THIS SECTION TO doctor.html -->
                    <div>
                        <h2 class="text-lg font-semibold text-green-200 mb-3">3. Generated FHIR ProblemList Resource</h2>
                        <div class="bg-black bg-opacity-30 rounded-md p-4 max-h-96 overflow-auto border border-gray-700">
                            <pre><code id="fhir-output" class="text-sm text-green-300 whitespace-pre-wrap">Loading FHIR resource...</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>


    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <script>

        // --- FIREBASE CONFIGURATION ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyB3rsUJsnIlBnvNo6iMIXD4yvUo17v-tx4",
        authDomain: "ayubridge-4db4d.firebaseapp.com",
        projectId: "ayubridge-4db4d",
        storageBucket: "ayubridge-4db4d.firebasestorage.app",
        messagingSenderId: "301931242885",
        appId: "1:301931242885:web:2f6703119f460a2b0810ec",
        measurementId: "G-FRGE5Q4VVL"
        };

        // INITIALIZE FIREBASE
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();



            // --- DOM ELEMENT REFERENCES (Unchanged) ---
        const patientSelect = document.getElementById('patient-select');
        const patientProblemList = document.getElementById('patient-problem-list');
        const searchInput = document.getElementById('diagnosis-search');
        const fhirOutput = document.getElementById('fhir-output');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const stagingAreaContainer = document.getElementById('staging-area-container');
        const saveToRecordBtn = document.getElementById('save-to-record-btn');

        // --- GLOBAL STATE VARIABLES ---
        let liveMappingsData = []; // Will be populated by our listener
        let livePatientsData = []; // Will be populated by our listener
        let stagedProblems = [];
        let currentPatientId = null;

        // --- DATA LOGIC: REAL-TIME LISTENERS (The "Read" Logic) ---

        // 1. Listen for any changes in the 'mappings' collection
        db.collection('mappings').onSnapshot(snapshot => {
            liveMappingsData = snapshot.docs.map(doc => ({ ...doc.data(), namaste_code: doc.id }));
            console.log("Live mappings data loaded:", liveMappingsData.length, "records");
            // If a search query is active, re-render suggestions with the new data
            if (searchInput.value) {
                renderSuggestions(searchInput.value);
            }
        }, error => {
            console.error("Error fetching mappings:", error);
        });

        // 2. Listen for any changes in the 'patients' collection
        db.collection('patients').onSnapshot(snapshot => {
            livePatientsData = snapshot.docs.map(doc => ({ ...doc.data(), patient_id: doc.id }));
            console.log("Live patients data updated:", livePatientsData.length, "records");

            // When patient data changes, we must re-render the UI that depends on it.
            const previouslySelected = currentPatientId;
            populatePatientSelector(livePatientsData);
            // If a patient was already selected, keep them selected after the refresh.
            if (previouslySelected) {
                patientSelect.value = previouslySelected;
                renderPatientProblemList(previouslySelected, livePatientsData, liveMappingsData);
                generateAndRenderFhirResource(previouslySelected, livePatientsData, liveMappingsData);
            }
        }, error => {
            console.error("Error fetching patients:", error);
            patientProblemList.innerHTML = `<p class="text-red-400">Error: Could not connect to patient database.</p>`;
        });


        // --- UI RENDERING FUNCTIONS (Modified to accept live data) ---

        function populatePatientSelector(patients) {
            patientSelect.innerHTML = '<option value="">-- Select a Patient --</option>';
            patients.forEach(p => {
                const option = document.createElement('option');
                option.value = p.patient_id;
                option.textContent = `${p.patient_name} (ID: ${p.patient_id})`;
                patientSelect.appendChild(option);
            });
        }

        function renderPatientProblemList(patientId, patients, mappings) {
            const patient = patients.find(p => p.patient_id === patientId);
            if (!patient || !patient.diagnoses || patient.diagnoses.length === 0) {
                patientProblemList.innerHTML = `<p class="text-gray-400 italic">No diagnoses on record.</p>`;
                return;
            }
            patientProblemList.innerHTML = patient.diagnoses.map(diag => {
                const mapping = mappings.find(m => m.namaste_code === diag.namaste_code);
                return `
                    <div class="bg-black bg-opacity-25 p-3 rounded-md">
                        <p class="font-bold text-green-300">${mapping?.namaste_term || 'Loading...'}</p>
                        <p class="text-xs text-gray-300"><strong>NAMASTE:</strong> ${diag.namaste_code} | <strong>ICD-11:</strong> ${mapping?.icd11_term || 'N/A'}</p>
                        <p class="text-xs text-gray-400">Recorded on: ${diag.date}</p>
                    </div>`;
            }).join('');
        }

        function generateAndRenderFhirResource(patientId, patients, mappings) {
            const patient = patients.find(p => p.patient_id === patientId);
            if (!patient) {
                fhirOutput.textContent = 'Select a patient to generate their FHIR record.';
                return;
            }

            const fhirResource = {
                resourceType: "List",
                id: `problem-list-${patient.patient_id}`,
                status: "current",
                mode: "snapshot",
                title: "Patient Problem List",
                subject: {
                    reference: `Patient/${patient.patient_id}`,
                    display: patient.patient_name
                },
                date: new Date().toISOString(),
                entry: (patient.diagnoses || []).map(diag => {
                    const mapping = mappings.find(m => m.namaste_code === diag.namaste_code) || {};
                    return {
                        item: {
                            display: `Condition: ${mapping.namaste_term || 'Unknown'} / ${mapping.icd11_term || 'N/A'}`,
                            // Using custom extensions to hold both codes is a valid FHIR pattern
                            _extension: [
                                {
                                    url: "http://ayubridge.org/namaste-code",
                                    valueCoding: {
                                        system: "http://nphce.org.in/namaste",
                                        code: diag.namaste_code,
                                        display: mapping.namaste_term
                                    }
                                },
                                {
                                    url: "http://ayubridge.org/icd11-code",
                                    valueCoding: {
                                        system: "http://id.who.int/icd/release/11/mms",
                                        code: mapping.icd11_code,
                                        display: mapping.icd11_term
                                    }
                                }
                            ]
                        }
                    };
                })
            };
            // Pretty-print the JSON object into the code block
            fhirOutput.textContent = JSON.stringify(fhirResource, null, 2);
        }

        function renderSuggestions(query) {
            if (!query || query.trim().length === 0) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            const lowerCaseQuery = query.toLowerCase();
            // Use liveMappingsData instead of the old mock data
            const results = liveMappingsData.filter(item =>
                item.namaste_term.toLowerCase().includes(lowerCaseQuery) ||
                item.icd11_term.toLowerCase().includes(lowerCaseQuery)
            );

            if (results.length > 0) {
                suggestionsContainer.innerHTML = results.map(item => `
                    <div class="p-3 cursor-pointer suggestion-item transition" data-code='${JSON.stringify(item)}'>
                        <p class="font-semibold text-white">${item.namaste_term}</p>
                        <p class="text-sm text-gray-400">Maps to ICD-11: ${item.icd11_term}</p>
                    </div>
                `).join('');
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.innerHTML = `<div class="p-3 text-gray-400">No results found.</div>`;
                suggestionsContainer.classList.remove('hidden');
            }
        }
        
        // Unchanged functions: renderStagingArea, removeStagedProblem
        function renderStagingArea() {
            if (stagedProblems.length === 0) {
                stagingAreaContainer.innerHTML = `<p class="text-gray-400 italic">Codes selected from search will appear here...</p>`;
                saveToRecordBtn.disabled = true;
            } else {
                stagingAreaContainer.innerHTML = stagedProblems.map((problem, index) => `
                    <div class="bg-blue-900 bg-opacity-50 p-3 rounded-md flex justify-between items-center">
                        <div>
                            <p class="font-bold text-blue-200">${problem.namaste_term}</p>
                            <p class="text-xs text-blue-300"><strong>NAMASTE:</strong> ${problem.namaste_code} | <strong>ICD-11:</strong> ${problem.icd11_term}</p>
                        </div>
                        <button onclick="removeStagedProblem(${index})" class="text-red-400 hover:text-red-300 font-bold text-xl">&times;</button>
                    </div>`).join('');
                saveToRecordBtn.disabled = false;
            }
        }
        function removeStagedProblem(index) {
            stagedProblems.splice(index, 1);
            renderStagingArea();
        }


        // --- EVENT LISTENERS ---
        patientSelect.addEventListener('change', (e) => {
            currentPatientId = e.target.value;
            if (currentPatientId) {
                // Pass the live data to the render function
                renderPatientProblemList(currentPatientId, livePatientsData, liveMappingsData);
            } else {
                patientProblemList.innerHTML = `<p class="text-gray-400 italic">Select a patient to view their record.</p>`;
            }
        });

        searchInput.addEventListener('input', () => renderSuggestions(searchInput.value));

        suggestionsContainer.addEventListener('click', (e) => {
            const suggestionItem = e.target.closest('.suggestion-item');
            if (suggestionItem) {
                const term = JSON.parse(suggestionItem.dataset.code);
                if (!stagedProblems.some(p => p.namaste_code === term.namaste_code)) {
                    stagedProblems.push(term);
                    renderStagingArea();
                }
                searchInput.value = '';
                suggestionsContainer.classList.add('hidden');
            }
        });

        // --- DATA LOGIC: The "Write" Logic ---
        saveToRecordBtn.addEventListener('click', () => {
            if (!currentPatientId) {
                alert('Please select a patient first.');
                return;
            }
            if (stagedProblems.length === 0) return;

            // Get a reference to the specific patient document in Firestore.
            const patientRef = db.collection('patients').doc(currentPatientId);

            // Prepare the new diagnoses in the format Firestore expects (an array of maps).
            const newDiagnoses = stagedProblems.map(problem => ({
                namaste_code: problem.namaste_code,
                date: new Date().toISOString().split('T')[0]
            }));

            // Use arrayUnion to safely add the new diagnoses to the existing array in Firestore.
            patientRef.update({
                diagnoses: firebase.firestore.FieldValue.arrayUnion(...newDiagnoses)
            })
            .then(() => {
                console.log("Patient record updated successfully in Firestore!");
                // Clear the staging area. The UI will update automatically because our listener will fire.
                stagedProblems = [];
                renderStagingArea();
                alert('Diagnoses have been successfully saved.');
            })
            .catch(error => {
                console.error("Error updating patient record: ", error);
                alert("Could not save diagnoses. Please check console for errors.");
            });
        });

        document.addEventListener('click', event => {
            if (!suggestionsContainer.contains(event.target) && event.target !== searchInput) {
                suggestionsContainer.classList.add('hidden');
            }
        });

        // --- INITIALIZATION ---
        // Initial renders are now handled by the listeners, but we can set initial states here.
        patientProblemList.innerHTML = `<p class="text-gray-400 italic">Loading patient data...</p>`;
        renderStagingArea();
    </script>

</body>
</html>

